<!DOCTYPE html>
<html>
<head>
    <title>Distributed Job Queue Dashboard</title>
    <meta charset="UTF-8">

    <style>
        body { font-family: sans-serif; margin: 20px; }
        h1 { margin-bottom: 15px; }

        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background: #f5f5f5; }

        .status-pill { padding: 3px 6px; border-radius: 4px; font-size: 12px; }
        .PENDING { background: #fffae6; }
        .RUNNING { background: #e6f0ff; }
        .COMPLETED { background: #e6ffed; }
        .FAILED, .DLQ { background: #ffe6e6; }

        textarea { width: 400px; height: 120px; margin-top: 8px; }

        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 6px;
            max-height: 200px;
            overflow: auto;
        }

        #alertBox {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #f44336;
            color: white;
            padding: 15px 20px;
            border-radius: 6px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            font-size: 14px;
            z-index: 9999;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        #alertBox.show { opacity: 1; transform: translateY(0); }
    </style>
</head>

<body>

<div id="alertBox"></div>

<h1>Distributed Job Queue Dashboard</h1>

<div>
    <label>Tenant:
        <input type="text" id="tenantId" value="new-tenant">
    </label>
</div>

<div style="margin-top: 20px;">
    <!-- Legend / Help Section -->
    <div style="margin-top: 20px; padding: 12px; border: 1px solid #ccc; border-radius: 6px; background: #f9f9f9;">
        <h3>Legend: Sample Payloads</h3>
        <p>Try any of the following JSON payloads:</p>

        <pre style="background:#efefef; padding:10px; border-radius:5px;">
<strong>1-> Change Page Text Color</strong>
{
  "task": "color change"
  "color": "red"/"blue"/"black" ...
}
    </pre>

        <pre style="background:#efefef; padding:10px; border-radius:5px;">
<strong>2 -> Force Job Failure (moves to DLQ eventually)</strong>
{
  "task": "failMe"
}
    </pre>

        <pre style="background:#efefef; padding:10px; border-radius:5px;">
<strong>3->  Normal Job (does nothing except complete)</strong>
{
  "task": "sendMail"
}
    </pre>

        <p style="font-size:13px; color:#555;">
            ðŸ’¡ Workers will parse your payload and apply actions.<br>
            Only <strong>color</strong> payloads trigger UI updates, <strong>failMe</strong> triggers retries/DLQ.
        </p>
    </div>

    <label><strong>Job Payload (JSON):</strong></label><br>
    <textarea id="payloadInput">
{
  "task": "change",
  "color": "red"
}
    </textarea>
</div>

<button id="submitBtn" style="margin-top: 10px;">Submit Job</button>
<button id="refreshBtn">Refresh</button>

<div style="margin-top:10px;">
    <label>
        <input type="checkbox" id="tenantFilterToggle">
        Show only current tenant summary
    </label>
</div>

<h2>Tenant Summary</h2>
<pre id="tenantSummary"></pre>

<h2>Global Summary</h2>
<pre id="globalSummary"></pre>

<h2>Jobs</h2>
<table>
    <thead>
    <tr>
        <th>ID</th>
        <th>Tenant</th>
        <th>Status</th>
        <th>Attempts</th>
        <th>MaxRetries</th>
        <th>Last Error</th>
        <th>Created</th>
    </tr>
    </thead>
    <tbody id="jobsTableBody"></tbody>
</table>

<h2>Recent Events</h2>
<pre id="eventsFeed"></pre>

<script>

    let tenantFilterEnabled = false;

    function showAlert(msg) {
        const box = document.getElementById("alertBox");
        box.textContent = "âš ï¸ " + msg;
        box.classList.add("show");
        setTimeout(() => box.classList.remove("show"), 3000);
    }

    async function submitJob() {
        const tenantId = document.getElementById('tenantId').value;
        const payloadText = document.getElementById('payloadInput').value;

        let parsed;
        try { parsed = JSON.parse(payloadText); }
        catch (e) { showAlert("Invalid JSON: " + e.message); return; }

        const res = await fetch('/api/jobs', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Tenant-Id': tenantId
            },
            body: JSON.stringify({
                payload: JSON.stringify(parsed),
                maxRetries: 3
            })
        });

        if (!res.ok) {
            showAlert(await res.text());
            return;
        }

        await refreshAll();
    }

    async function refreshSummary() {
        const tenantId = document.getElementById('tenantId').value;

        const tRes = await fetch(`/api/jobs/summary?tenantId=${tenantId}`);
        document.getElementById('tenantSummary').textContent =
            JSON.stringify(await tRes.json(), null, 2);

        if (!tenantFilterEnabled) {
            const gRes = await fetch("/api/jobs/summary/global");
            document.getElementById('globalSummary').textContent =
                JSON.stringify(await gRes.json(), null, 2);
        } else {
            document.getElementById('globalSummary').textContent =
                "Global summary hidden (filter ON)";
        }
    }

    async function refreshJobs() {
        const tenantId = document.getElementById('tenantId').value;

        let headers = {};
        if (tenantFilterEnabled) headers['X-Tenant-Id'] = tenantId;

        const res = await fetch("/api/jobs", { headers });
        const jobs = await res.json();

        const tbody = document.getElementById('jobsTableBody');
        tbody.innerHTML = "";

        jobs.forEach(job => {
            tbody.innerHTML += `
            <tr>
                <td>${job.id}</td>
                <td>${job.tenantId}</td>
                <td><span class="status-pill ${job.status}">${job.status}</span></td>
                <td>${job.attemptCount}</td>
                <td>${job.maxRetries}</td>
                <td>${job.lastError || ""}</td>
                <td>${job.createdAt}</td>
            </tr>`;
        });
    }

    async function refreshEvents() {
        const res = await fetch("/api/events");
        if (!res.ok) return;

        const events = await res.json();

        const text = events
            .map(evt =>
                `[${evt.timestamp}] [${evt.eventType}] Job ${evt.jobId} (${evt.tenantId}) â†’ ${evt.message}`
            )
            .join("\n");

        document.getElementById("eventsFeed").textContent = text;

        const sortedEvents = [...events].sort(
            (a, b) => new Date(a.timestamp) - new Date(b.timestamp)
        );

        const latestColorEvent = sortedEvents
            .slice()
            .reverse()
            .find(e => e.eventType === "COLOR_CHANGE");

        if (latestColorEvent) {
            const color = latestColorEvent.message;
            document.body.style.color = color;   // change entire page text color
        }
    }

    async function refreshAll() {
        await refreshSummary();
        await refreshJobs();
        await refreshEvents();
    }

    document.getElementById("submitBtn").addEventListener("click", submitJob);
    document.getElementById("refreshBtn").addEventListener("click", refreshAll);
    document.getElementById("tenantFilterToggle").addEventListener("change", () => {
        tenantFilterEnabled = document.getElementById("tenantFilterToggle").checked;
        refreshAll();
    });

    refreshAll();
    setInterval(refreshAll, 3000);

</script>

</body>
</html>
